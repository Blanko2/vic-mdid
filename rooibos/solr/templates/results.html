{% extends "master.html" %}
{% load ui %}
{% load help %}
{% load humanize %}

{% block help %}
    {% pagehelp 'facet_search' %}
{% endblock %}

{% block javascript %}
{{ block.super }}
<script type="text/javascript">
    function selectAllOnPage() {
        ids = Array();
        $(".record-select").each(function (i) { ids[i] = this.value; }).val(ids);
        recordSelection(ids, true);
    }
    $(document).ready(function() {
        $("#submit_record_selections").replaceWith($("<input type='button' value='Select all on page'>").click(selectAllOnPage));
        
        $(".facet-body").each(function(i, facet) {
            function sortByFreq(a, b) {
                var fa = $(".facet-freq", a).text().replace(/,/, "");
                var fb = $(".facet-freq", b).text().replace(/,/, "");
                fa = fa ? parseInt(fa) : 0;
                fb = fb ? parseInt(fb) : 0;
                return ((fa < fb) ? -1 : ((fa > fb) ? 1 : 0));
            }            
            var terms = jQuery.makeArray($(".facet-line", facet)).sort(sortByFreq).reverse().slice(10);            
            if (terms.length)
            {
                $(terms).hide();
                $(".facet-more", facet).click(function() { $(this).hide(); $(terms).show(); return false; }).show();
            }            
        });
        
        $("#sort_dropdown, #viewmode_dropdown").change(function() { $("form").submit(); })
        $("#sort_go_button").hide();
        
    });
</script>    
{% endblock %}    
    
{% block raw-content %}

<form id="flickr_form" name="flickr_form" method="POST" action="{% url flickr-photo-search %}">
    <input name="search_string" type="hidden" value="{{ keywords }}" />
</form>
<form id="artstor_form" name="artstor_form" method="POST" action="{% url artstor-photo-search %}">
    <input name="search_string" type="hidden" value="{{ keywords }}" />
</form>

<form method="GET" action="{{ form_url }}">

<div class="horizontal-block">
Your query found {{ hits|intcomma }} hit{{ hits|pluralize }}.
{% if pages %}
    Page {{ page|intcomma }} of {{ pages|intcomma }}.
    {% if prev_page %}<a href="{{ prev_page }}">Previous</a>{% endif %}
    {% if next_page %}<a href="{{ next_page }}">Next</a>{% endif %}
{% endif %}

<a href="{{ reset_url }}">Reset</a>
{% if debug %}<span title="{{query}}">[raw]</span>{% endif %}
<input id="submit_record_selections" type="submit" name="action" value="Select" />

Found <a href="javascript:document.flickr_form.submit()">{{ flickr_total }}</a> results from Flickr.
Found <a href="javascript:document.artstor_form.submit()">{{ artstor_total }}</a> results from ARTstor.
</div>

{% for f,v in hiddenfields %}
<input type="hidden" name="{{ f }}" value="{{ v }}" />
{% endfor %}
<div class="horizontal-block">
    Keywords: <input type="text" name="kw" value="{{ keywords }}"/>
    <input type="submit" value="Go" />
{% for c in criteria %}
  | {{ c.1 }}
  {% if c.2 %}<a href="{{ limit_url }}or={{ c.0|urlencode }}" class="icon or-icon" title="Add additional term"><span>(or ...)</span></a>{% endif %}
  <a href="{{ limit_url }}rem={{ c.0|urlencode }}" class="icon remove-icon" title="Remove this criteria"><span>(remove)</span></a>  
{% endfor %}
    View:
    <select name="v" id="viewmode_dropdown">
        <option value="thumb"{% ifequal viewmode "thumb" %} selected="selected"{% endifequal %}>Thumbnails</option>
        <option value="list"{% ifequal viewmode "list" %} selected="selected"{% endifequal %}>List</option>
    </select>
    Sort by:
    <select name="s" id="sort_dropdown">
        <option value="score desc"{% ifequal sort "score" %} selected="selected"{% endifequal %}>Score</option>
        <option value="random_{{ random }}"{% ifequal sort "random" %} selected="selected"{% endifequal %}>Random</option>
{% for f in sortfields %}
        <option value="{{ f.name }}_sort"{% ifequal sort f.name %} selected="selected"{% endifequal %}>{{ f.label }}</option>
{% endfor %}
    </select>
    <input type="submit" value="Go" id="sort_go_button" />
</div>

<div class="facets">
{% if orfacet.facets %}
    <div class="facet">
        <div class="facet-header">{{ orfacet.label }}</div>
        <div class="facet-body">
        {% for term,freq,label in orfacet.facets %}
            <div class="facet-line">
            <a href="{{ limit_url_orquery }}c={{ orquery }}|{{ term|urlencode }}" rel="nofollow">{{ label|default:term }}</a>{% if freq %}&nbsp;{{ freq|intcomma  }}{% endif %}
            </div>
        {% endfor %}
        <a class="facet-more" style="display: none;" href="#{{ orfacet.name|urlencode }}">more...</a>
        </div>
    </div>
{% endif %}

{% for facet in facets %}
{% if facet.facets %}
    <div class="facet">
        <div class="facet-header">{{ facet.label }}</div>
        <div class="facet-body">
        {% for term,freq,label in facet.facets %}
            <div class="facet-line">            
            <a href="{{ limit_url }}c={{ facet.name }}:{{ term|urlencode }}" rel="nofollow">{{ label|default:term }}</a>{% if freq %}&nbsp;<span class="facet-freq">{{ freq|intcomma  }}</span>{% endif %}&nbsp;(<a
               href="{{ limit_url }}c=-{{ facet.name }}:{{ term|urlencode }}" rel="nofollow">&times;</a>)
            </div>
        {% endfor %}
        <a class="facet-more" style="display: none;" href="#{{ facet.name|urlencode }}">more...</a>
        </div>
    </div>
{% endif %}    
{% endfor %}
</div>

{% if records %}
<div class="resultlist">
{% for r in records %}
    {% record r 'selectable' viewmode %}
{% endfor %}
</div>
{% endif %}

</form>
{% endblock %}
