{% extends "master.html" %}
{% load ui %}
{% load help %}
{% load humanize %}
{% load solr %}


{% block javascript %}
<script type="text/javascript">
  custom_process_facets = true;
</script>
{{ block.super }}
<script type="text/javascript">

    // preload facet loading image
    var img = new Image();
    img.src = '{% url static 'images/loading.gif' %}';

    function selectAllOnPage() {
        ids = Array();
        $(".record-select").each(function (i) { ids[i] = this.value; }).val(ids);
        recordSelection(ids, true);
    }
    $(document).ready(function() {
        $("#submit_record_selections").replaceWith($("<input type='button' value='Select all on page'>").click(selectAllOnPage));

        $("#sort_dropdown, #viewmode_dropdown").change(function() { $("#explore-form").submit(); })
        $("#sort_go_button").hide();
    {% if not facets %}
        $("#facets").html("<div style='text-align: center;'>Loading facets <img src='{% url static 'images/loading.gif' %}' alt='Loading' /><\/div>");
    {% endif %}
    });
    
    $(window).load(function() {
    {% if facets %}
    {% else %}
        ajaxManager.add({
                type: 'GET',
                url: '{{ facets_url|escapejs }}',
                dataType: 'json',
                success: function(r) {
//                    var t=new Date().getTime();
                    var facets = $("#facets");
                    facets.hide();
                    facets[0].innerHTML = r.html;
                    process_facets();
//                    alert(new Date().getTime()-t);
                    facets.slideDown(500);
                }
            });
    {% endif %}
    });
</script>
{% endblock %}



{% block sidebar %}
{{ block.super }}

  <div class="facet active-facet">
    <div class="facet-header">Keywords</div>
    <div class="facet-body">
        <input type="text" id="keywords" name="kw" value="{{ keywords }}"/><input type="image" class="image" src="{% url static 'images/med_go_button.png' %}" value="Go" />
    </div>
  </div>
    
{% for c in criteria %}
  <div class="facet active-facet">
    <div class="facet-header"><a href="{{ limit_url }}rem={{ c.facet|urlencode }}" class="icon remove-icon" title="Remove this criteria"><img src="{% url static 'images/facet_close.png' %}" alt="Remove" title="Remove" /></a>{{ c.label }}</div>
    <div class="facet-body">{% if c.negated %}not {% endif %}{{ c.term }}
        {% if c.or_available %}<a href="{{ limit_url }}or={{ c.facet|urlencode }}" class="icon or-icon" title="Add additional term"><img src="{% url static 'images/or_icon.png' %}" alt="Or" title="Or" /></a>{% endif %}        
    </div>
  </div>
    
{% endfor %}

{% if orfacet.facets %}
    <div class="facet">
        <div class="facet-header">{{ orfacet.label }}</div>
        <div class="facet-body">
        {% for term,freq,label in orfacet.facets %}
            <div class="facet-line">
            <a href="{{ limit_url_orquery }}c={{ orquery }}|{{ term|quoteterm|urlencode }}" rel="nofollow">{{ label|default:term }}</a>{% if freq %}&nbsp;{{ freq|intcomma  }}{% endif %}
            </div>
        {% endfor %}
        <a class="facet-more" style="display: none;" href="#{{ orfacet.name|urlencode }}">more...</a>
        </div>
    </div>
{% endif %}

<div id="facets">
{% include "results_facets.html" %}
</div>

<div style="text-align: center; margin-top: 20px;">
    <a href="{{ reset_url }}">Reset Search</a>
    {% if debug %}<span title="{{query}}">[raw]</span>{% endif %}
</div>

{% endblock %}


{% block content-top %}

<!--
<form id="flickr_form" name="flickr_form" method="POST" action="{% url flickr-photo-search %}">
    <input name="search_string" type="hidden" value="{{ keywords }}" />
</form>
<form id="artstor_form" name="artstor_form" method="POST" action="{% url artstor-photo-search %}">
    <input name="search_string" type="hidden" value="{{ keywords }}" />
</form>
-->
<form method="GET" action="{{ form_url }}" id="explore-form">
{% for f,v in hiddenfields %}
<input type="hidden" name="{{ f }}" value="{{ v }}" />
{% endfor %}

<div style="float: right;">
<!--    
    <span class="imagebar">
    {% spaceless %}
    {% ifequal viewmode "thumb" %}
    <input type="image" name="v" value="list" src="{% url static 'images/listview_off.png' %}"
           alt="List view" title="List view"/>
    <img src="{% url static 'images/thumbnailview_on.png' %}"
           alt="Thumbnail view" title="Thumbnail view" />
    {% endifequal %}
    {% ifequal viewmode "list" %}
    <img src="{% url static 'images/listview_on.png' %}"
           alt="List view" title="List view"/>
    <input type="image" name="v" value="thumb" src="{% url static 'images/thumbnailview_off.png' %}"
           alt="Thumbnail view" title="Thumbnail view" />    
    {% endifequal %}
    {% endspaceless %}
    </span>
    
-->    
    View:
    <select name="v" id="viewmode_dropdown">
        <option value="thumb"{% ifequal viewmode "thumb" %} selected="selected"{% endifequal %}>Thumbnails</option>
        <option value="list"{% ifequal viewmode "list" %} selected="selected"{% endifequal %}>List</option>
    </select>


    Sort by:
    <select name="s" id="sort_dropdown">
        <option value="score desc"{% ifequal sort "score" %} selected="selected"{% endifequal %}>Score</option>
        <option value="random_{{ random }}"{% ifequal sort "random" %} selected="selected"{% endifequal %}>Random</option>
{% for f in sortfields %}
        <option value="{{ f.name }}_sort"{% ifequal sort f.name %} selected="selected"{% endifequal %}>{{ f.label }}</option>
{% endfor %}
    </select>
    <input type="submit" value="Go" id="sort_go_button" />    
</div>

<div style="float: left;">
    Your query found {{ hits|intcomma }} hit{{ hits|pluralize }}.
    <input id="submit_record_selections" type="submit" name="action" value="Select" />
</div>

{% if pages %}
<div style="text-align: center;">
    {% if prev_page %}<a href="{{ prev_page }}">Previous</a>{% endif %}
    <span style="padding: 0 20px;">Page {{ page|intcomma }} of {{ pages|intcomma }}</span>
    {% if next_page %}<a href="{{ next_page }}">Next</a>{% endif %}
</div>
{% endif %}

{% endblock %}


{% block content %}
<!--
Found <a href="javascript:document.flickr_form.submit()">{{ flickr_total }}</a> results from Flickr.
Found <a href="javascript:document.artstor_form.submit()">{{ artstor_total }}</a> results from ARTstor.
-->

{% if records %}
<div id="resultlist" class="resultlist-{{ viewmode }}">
{% for r in records %}
    {% record r 'selectable' viewmode %}
{% endfor %}
</div>
{% endif %}

{% if pages %}
<div style="text-align: center; clear: both;">
    {% if prev_page %}<a href="{{ prev_page }}">Previous</a>{% endif %}
    <span style="padding: 0 20px;">Page {{ page|intcomma }} of {{ pages|intcomma }}</span>
    {% if next_page %}<a href="{{ next_page }}">Next</a>{% endif %}
</div>
{% endif %}

</form>

{% endblock %}
