{% load ui %}
{% load help %}
{% load analytics %}
{% load humanize %}
{% load compress %}
{% load userprofile %}
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>{% block title %}MDID 3 {% block titledetail %}{% endblock %}{% endblock %}</title>
{% block stylesheets %}
{% compress css %}
    <link href="{% url static 'css/reset.css' %}" rel="stylesheet" type="text/css" media="screen">
    <link href="{% url static 'css/typography.css' %}" rel="stylesheet" type="text/css" media="screen">
    <link href="{% url static 'jquery/jquery.autocomplete.css' %}" rel="stylesheet" type="text/css" media="screen">
    <link href="{% url static 'jquery/jquery-ui-themeroller.css' %}" rel="stylesheet" type="text/css" media="screen">
{% endcompress %}
    {% include "master.css" %}
<!--[if IE]>
{% compress css %}
    {% include "master-ie.css" %}
{% endcompress %}        
<![endif]-->
{% endblock %}
</head>

<body class="ui-reset master">

{% block raw-content %}
    <div id="content-wrapper">        
        <div id="content">

{% if messages %}
<div id="messages">
    {% for message in messages %}
    <span>{{ message }}</span><br />
    {% endfor %}
</div>
{% endif %}

{% block content-top %}
{% endblock %}

<div id="sidebar">
{% block sidebar %}
{% include "ui_related_pages.html" %}
{% endblock %}
</div>

{% block content %}
{% endblock %}

{% block footer %}
            <div id="footer">
                Copyright 1997-2010 James Madison University
            </div>
{% endblock %}

        </div>
    </div>
{% endblock %}

{% block basket %}
<div id="basket-content">
    <div id="basket-menu">See all</div>
    <div id="basket-scroll-right"></div>
    <div id="basket-scroll-left"></div>
    <div id="basket-thumbs">{% include "ui_basket.html" %}</div>
</div>
<div id="basket-tab" title="Click to keep open or automatically hide">{% include "ui_basket_header.html" %}</div>
{% endblock %}

{% block header %}
    <div id="topmenu">
        <ul>
            {% if user.is_authenticated %}
            <li>Welcome{% if user.first_name %}, {{ user.first_name }}{% endif %}</li>
            <li><a href="{% url logout %}">Log out</a></li>
            <li><a href="{% url ui-options %}">Options</a></li>
            <li><a href="{% url ui-management %}">Management</a></li>
            {% else %}
            <li><a href="{% url login %}?next={{ request.get_full_path }}">Log in</a></li>
            {% endif %}
            <li>{% block help %}{% pagehelp 'main' %}{% endblock %}</li>
        </ul>
        <span id="javascriptwarning">You have JavaScript disabled.  MDID works better with JavaScript enabled.</span>
    </div>    
    
    <div id="header-bar">
        <div class="spacer">
            <div id="header">
                <a href="{% url main %}" id="logo"></a>
                <div id="branding"></div>
                <ul>
                    <li><a href="{% url solr-search %}">Discover</a>
                        <ul class="menu">
                            <li><a href="{% url solr-search %}">Explore</a></li>
                            <li><a href="{% url solr-searchform %}">Search</a></li>
                            <li><a href="{% url solr-browse %}">Browse</a></li>
                            <li><a href="{% url solr-overview %}">Overview</a></li>
                        </ul>
                    </li>
                    {% if user.is_authenticated %}
                    <li><a href="{% url presentation-manage %}">Organize</a>
                        <ul class="menu">
                            <li><a href="{% url presentation-manage %}">Presentations</a></li>
                            <li><a href="{% url solr-search %}?c=ownedtag:{{ user.id }}-favorite">Favorites</a></li>
                            <li><a href="{% url solr-search %}?c=owner:{{ user.id }}">Content</a></li>
                        </ul>
                    </li>
                    {% endif %}
                    <li><a href="{% url presentation-browse %}">Experience</a>
                        <ul class="menu">
                            <li><a href="{% url presentation-browse %}">Browse Presentations</a></li>
                            <li><a href="{% url showcases %}">Showcases</a></li>
                            <li><a href="{% url about %}">About</a></li>
                        </ul>
                    </li>
                    <li class="search"><span style="display: none;">Search</span>
                        <form method="GET" action="{% url solr-search %}">
                            <input id="quicksearch" name="kw" type="text" title="Search" /><input type="image" src="{% url static 'images/go.png' %}" />
                        </form>
                    </li>
                </ul>
            </div>
        </div>        
    </div>
{% endblock %}

<!--
<div id="related-images-bar" style="display: none;">
    <div id="related-images-bar-toggle">
        <div id="related-images-bar-hide" style="float: right;"></div>
        <span id="related-images-bar-hint"></span>
        <span id="related-images-bar-all" style="margin-left: 20px; "></span>
    </div>
    <div id="related-images-bar-content"></div>
</div>
<div id="related-images-bar-placeholder" style="visibility: hidden;"></div>
-->

{% analytics %}

{% if debug %}<!--
{{ sql_queries|length }} queries:
{% for q in sql_queries %}
{{ q.sql }} ({{ q.time }})
{% endfor %}
-->
<div id="stats"><!-- STATS: Total: %(totTime).2fs <br/>Python: %(pyTime).2fs <br/>DB: %(dbTime).2fs <br/>Queries: %(queries)d --></div>
{% endif %}

<script type="text/javascript">
    var profile_settings = {% profile_settings %};
    var custom_process_facets = false;
</script>
{% block javascript %}
{% compress js %}
    <script type="text/javascript" src="{% url static 'jquery/jquery-1.4.1.js' %}"></script>
    <script type="text/javascript" src="{% url static 'jquery/jquery-ui-1.7.2.custom.min.js' %}"></script>
    <script type="text/javascript" src="{% url static 'jquery/jquery.cookie.js' %}"></script>
    <script type="text/javascript" src="{% url static 'jquery/jquery.hoverIntent.minified.js' %}"></script>
    <script type="text/javascript" src="{% url static 'jquery/jquery.ajaxmanager.js' %}"></script>
    <script type="text/javascript" src="{% url static 'jquery/jquery.autocomplete.pack.js' %}"></script>
    <script type="text/javascript">
        var ajaxManager = $.manageAjax.create('cacheQueue', { queue: true });
    </script>
    <script type="text/javascript" src="{% url static 'scripts/ui-scripts.js' %}"></script>
    <script type="text/javascript" src="{% url static 'scripts/json2.js' %}"></script>
    <!--<script type="text/javascript" src="{% url static 'scripts/related-images-bar.js' %}"></script>-->
    <!--<script type="text/javascript" src="/jsi18n/"></script>-->
{% endcompress %}    
    <script type="text/javascript">
        function basket_scroll_arrows() {
            $("#basket-scroll-left").css("visibility", ($("#basket-thumbs img:hidden:first").length > 0) ? "visible" : "hidden");
            $("#basket-scroll-right").css("visibility",  ($("#basket-thumbs img").filter(function() { return ($(this).position().top > 0); }).length > 0) ? "visible" : "hidden");
        }
        
        function recordSelection(ids, checked) {
            var method = ids == 0 ? 'GET' : 'POST';
            if (!ids.length) ids = [ids];
            ids = $.map(ids, function(e) { return parseInt(e); });
            ajaxManager.add({
                type: method,
                url: '{% url ui-api-select-record %}',
                data: {'id': JSON.stringify(ids), 'checked': checked},
                dataType: 'json',
                success: function(r) {
                    $("#basket-thumbs").html(r.basket);
                    $("#basket-tab").html(r.header);
                    basket_scroll_arrows();
                }
            });
        }

        function bindSelectRecordCheckboxes() {
            $(".record-select").click(function() { recordSelection($(this).attr('value'), $(this).attr('checked')); });
        }
        
        function store_profile_setting(key, value) {
            ajaxManager.add({
                type: 'POST',
                url: '{% url userprofile-store %}',
                data: {'key': key, 'value': value},
                dataType: 'json'
            });
        }

        function process_facets() {
            $(".facet-body").each(function(i, facet) {
                function sortByFreq(a, b) {
                    var fa = $(".facet-freq", a).text().replace(/,/, "");
                    var fb = $(".facet-freq", b).text().replace(/,/, "");
                    fa = fa ? parseInt(fa) : 0;
                    fb = fb ? parseInt(fb) : 0;
                    return ((fa < fb) ? -1 : ((fa > fb) ? 1 : 0));
                }
                var terms = jQuery.makeArray($(".facet-line", facet)).sort(sortByFreq).reverse().slice(10);
                if (terms.length)
                {
                    $(terms).hide();
                    $(".facet-more", facet).click(function() { $(this).hide(); $(terms).show(); return false; }).show();
                }
            });
            
            $(".facet-header.collapsed").next().hide();
            
            $(".facet-header").each(function() {
                var id = $(this).parent().attr('id');
                if (id) {
                    var s = profile_settings['ui_' + id];
                    if (s == "true")
                        $(this).next().show();
                    else if (s == "false")
                        $(this).next().hide();
                }
            }).click(function() {
                var id = $(this).parent().attr('id');
                if (id) store_profile_setting('ui_' + id, $(this).next().is(':hidden'));
                $(this).next().toggle('fast');
                return false;
            }).css('cursor', 'pointer').children().click(function(event) { event.stopPropagation(); /* to keep links in facet header working */});            
            
            $(".facet-line").hover(function() { $(this).find(".facet-exclude").show(); },
                                   function() { $(this).find(".facet-exclude").hide(); }).
                             find(".facet-exclude").hide();
        };

        $(document).ready(function() {
            $("#javascriptwarning").hide();
            $("#header-bar,#header ul li,#content").addClass("js-enabled");
            var timeouts = Object();
            var resetwidth = function() { $(this).width($(this).parent().width() + 30); };
            $("#header ul.menu").addClass("js-enabled").each(resetwidth).hide();
            $("#header>ul>li:has(ul)").mouseenter(function() {
                clearTimeout(timeouts[$(this)]);
                $("#header>ul>li").not($(this)).removeClass("selected").children("ul").stop().attr("style", "").hide().each(resetwidth);
                if (!($(this).hasClass("selected"))) $(this).addClass("selected").children("ul").slideDown(200);
            }).mouseleave(function() {
                var lthis = $(this);
                timeouts[lthis] = setTimeout(function() { lthis.removeClass("selected").children("ul").hide(); }, 1000);
            });
            $("#header .search form").hide();
            $("#header .search span").show().mouseenter(function() {
                $("#header .search span,#header .search form").toggle();
            });

            $("#quicksearch").hint();

            // Basket features
            var basket_open = profile_settings['ui_basket_open'] == 'true';
            var baskettimeout;
            var basket_height = $("#basket-content").css('height');
            function hideBasket() {
                if (basket_open) return;
                clearTimeout(baskettimeout);
                baskettimeout = setTimeout(function() {
                    $("#basket-content").animate({ bottom: "-" + basket_height },500);
                    $("#basket-tab").animate({ bottom: 0 }, 500);
                    }, 500);
            }
            function showBasket() {
                clearTimeout(baskettimeout);
                $("#basket-content").animate({ bottom: 0 }, 500);
                $("#basket-tab").animate({ bottom: basket_height }, 500);
            }
            $("#basket-tab, #basket-content").hover(showBasket, hideBasket);
            $("#basket-tab").hover(function() {
                if (!basket_open) $("#basket-tab").css('background-image', 'url({% url static 'images/open_basket_icon.png' %})');
            }, function() {
                if (!basket_open) $("#basket-tab").css('background-image', 'url({% url static 'images/closed_basket_icon.png' %})');
            }).click(function() {
                basket_open = !basket_open;
                store_profile_setting('ui_basket_open', basket_open);
            });
            if (basket_open)
                $("#basket-tab").css('background-image', 'url({% url static 'images/open_basket_icon.png' %})');
            else
                hideBasket();            
            $("#basket-scroll-right").click(function() {
                if ($("#basket-thumbs img").filter(function() { return ($(this).position().top > 0); }).length > 0) {
                    var last = 0;
                    $("#basket-thumbs img").filter(function() { return ($(this).position().top == 0); }).each(
                        function(i) { $(this).delay(20 * i).hide(0); last = i; });
                    setTimeout(basket_scroll_arrows, (last + 1) * 20);
                }
            });
            $("#basket-scroll-left").click(function() {
                if ($("#basket-thumbs img:hidden").length > 0) {
                    var first = $("#basket-thumbs img:visible:first");
                    function scroll_left() {
                        if (first.position().top == 0 && $("#basket-thumbs img:hidden:last").show().length == 1)
                            setTimeout(scroll_left, 20);
                        else
                            basket_scroll_arrows();
                    }
                    scroll_left();
                }
            });
            $("#basket-content").css('overflow', 'hidden');
            basket_scroll_arrows();
            
            bindSelectRecordCheckboxes();
            
            if (!custom_process_facets) process_facets();
            $(".autocomplete-user").autocomplete('{% url api-autocomplete-user %}', {});
        });
    </script>

{% endblock %}
</body>

</html>
