{% extends "master.html" %}
{% load ui %}
{% load humanize %}
{% load pagination_tags %}
{% load viewers %}


{% block raw-content %}
<form action="{{ request.get_full_url }}" method="POST">{% csrf_token %}
{{ block.super }}
</form>
{% endblock %}


{% block sidebar %}
{{ block.super }}

{% if presentations %}
  <div class="facet active-facet" id="presentations_sidebar_keywords">
    <div class="facet-header">Keywords</div>
    <div class="facet-body">
        <input type="text" id="keywords" name="kw" value="{{ keywords }}"/><input type="image" class="image" src="{% url static 'images/med_go_button.png' %}" value="Go" name="keywords_go" />
    </div>
  </div>
{% endif %}

{% var as refine %}
{ "url": "{{ request.path }}?{% if active_presenter %}presenter={{ active_presenter|urlencode }}&{% endif %}kw={{ keywords|urlencode }}&{% for t in active_tags %}t={{ t|urlencode }}&{% endfor %}" }
{% endvar %}

{% if active_presenter and not manage %}
  <div class="facet active-facet">
    <div class="facet-header"><a href="{% url presentation-browse %}?kw={{ keywords|urlencode }}&amp;t={{ active_tags|join:"||"|urlencode }}" title="Remove this criteria"><img src="{% url static 'images/facet_close.png' %}" alt="Remove" title="Remove" class="facet-close" /></a>Presenter</div>
    <div class="facet-body">{% if active_presenter.last_name %}{{ active_presenter.last_name }}, {{ active_presenter.first_name }}{% else %}{{ active_presenter.username }}{% endif %}</div>
  </div>
{% endif %}

{% for tag in active_tags %}
  <div class="facet active-facet">
    <div class="facet-header"><a href="{{ refine.url }}rt={{ tag|urlencode }}"  title="Remove this criteria"><img src="{% url static 'images/facet_close.png' %}" alt="Remove" title="Remove" class="facet-close" /></a>Tag</div>
    <div class="facet-body">{{ tag }}</div>
  </div>
{% endfor %}

{% if presenters %}
  <div class="facet" id="presentations_sidebar_presenters">
    <div class="facet-header">Presenters</div>
    <div class="facet-body">
    {% for presenter in presenters %}
        <div class="facet-line">
            <a href="{{ refine.url }}presenter={{ presenter.username|urlencode }}">{% if presenter.last_name %}{{ presenter.last_name }}, {{ presenter.first_name }}{% else %}{{ presenter.username }}{% endif %}</a>
            &nbsp;<span class="facet-freq">{{ presenter.presentations|intcomma  }}</span>
        </div>
    {% endfor %}
    <a class="facet-more" style="display: none;" href="#presenters">more...</a>
    </div>
  </div>
{% endif %}

{% if tags %}
  <div class="facet" id="presentations_sidebar_tags">
    <div class="facet-header">Tags</div>
    <div class="facet-body">
    {% for tag in tags %}
        <div class="facet-line">
            <a href="{{ refine.url }}t={{ tag|urlencode }}">{{ tag }}</a>
            {% if tag.count %}&nbsp;<span class="facet-freq">{{ tag.count|intcomma  }}</span>{% endif %}
        </div>
    {% endfor %}
    <a class="facet-more" style="display: none;" href="#tags">more...</a>
    </div>
  </div>
{% endif %}

{% if usertags %}
  <div class="facet" id="presentations_sidebar_your_tags">
    <div class="facet-header">Your Tags</div>
    <div class="facet-body">
    {% for tag in usertags %}
        <div class="facet-line">
            <a href="{{ refine.url }}t={{ tag|urlencode }}">{{ tag }}</a>
            {% if tag.count %}&nbsp;<span class="facet-freq">{{ tag.count|intcomma  }}</span>{% endif %}
        </div>
    {% endfor %}
    <a class="facet-more" style="display: none;" href="#tags">more...</a>
    </div>
  </div>
{% endif %}

<div style="text-align: center; margin-top: 20px;">
    <a href="{{ request.path }}">Reset Search</a>
</div>

{% endblock %}



{% block stylesheets %}
{{ block.super }}
<style type="text/css">

#actionbar {
  border: solid thin {{ PRIMARY_COLOR }};
  border-left-color: lightgrey;
  border-right-color: lightgrey;
  height: 1.7em;
  margin: 0;
  background: url({% url static 'images/actionbar-gradient.png' %}) bottom repeat-x;
}

#actionbar .pagination {
  float: right;
  clear: none;
  border: none;
}

#actionbar li {
  list-style: none;
  float: left;
  padding: 0.2em 0.5em;
  border-right: solid thin {{ PRIMARY_COLOR }};
}

#actionbar a {
  text-decoration: none;
  color: black;
}

#actionbar li > input {
  background: none;
  border: none;
}

html.js-enabled #actionbar li div.dropdown {
  display: none;
  position: absolute;
  background: #f2f2f2;
  border: solid thin {{ PRIMARY_COLOR }};
  padding: 0.5em;
  margin-top: 0.2em;
  -moz-box-shadow: 3px 3px 5px lightgrey;
  -webkit-box-shadow: 3px 3px 5px lightgrey;
}

</style>

{% endblock %}



{% block javascript %}

{{ block.super }}

<script type="text/javascript" src="{% url static 'jquery/jquery.multicheckbox.js' %}"></script>

<script type="text/javascript">

function update_tag_checkboxes(menu) {
  var tags = {};
  var rows = 0;
  // get selected rows and count different tags
  $("input:checkbox:checked[name=h]").each(function() {
    var row = $(this).parent().parent();
    var t = $("span.tag span.t", row).text();
    tags[t] = (tags[t] || 0) + 1;
    rows++;
  });
  $("input:checkbox", menu).each(function() {
    var t = $(this).next().text();
    var c = $("<input type='checkbox' value='true' />");
    c.attr('name', $(this).attr('name'));
    if (tags[t]) {
      if (tags[t] == rows) {
        c.attr('checked', 'checked');
      } else {
        c.multicheckbox({'mixed': true});
      }
    } else {
      c.attr('checked', '');
    }
    $(this).replaceWith(c);
  });
}


$(document).ready(function() {

  $(document).click(function() {
    $("#actionbar li div.dropdown").hide();
  });
  $("#actionbar li div.dropdown").click(function(event) {
    event.stopPropagation();
  }).each(function() {
    var d = $(".dropdown-anchor", $(this).parent());
    d.click(function() {
        var r = $(this).parent();
        var menu = $("div.dropdown", r);
        if (menu.is(":visible")) {
          menu.hide();
        } else {
          var o = {
            left: r.offset().left - 1,
            top: r.offset().top + r.height() + 3
          };
          // apply offset twice, first time around does not always work on Chrome
          menu.offset(o).offset(o).show();
          update_tag_checkboxes(menu);
        }
        return false;
      }).css("cursor", "pointer");
  }).css("cursor", "default");

  $("#update_tags").click(function() {
    $("#actionbar li div.dropdown").hide();
    $("input:checkbox[name^=update_tag_]").each(function() {
      var c = $(this);
      if (!c.is(':checked')) {
        c.attr('value', 'false').attr('checked', 'checked');
      }
    });
  });

});

</script>

{% endblock %}


{% block content-top %}

{% autopaginate presentations 10 %}

<h1>{{ manage|yesno:"Manage,Browse" }} Presentations</h1>


<ul id="actionbar">

{% if manage %}
<li><a href="{% url presentation-create %}?next={% url presentation-manage %}">Create new presentation</a></li>
{% endif %}

<li><span class="dropdown-anchor">Tags <img src="{% url static 'images/down_arrow.png' %}" /></span>
<div class="dropdown">
  <div style="max-height: 200px; overflow: auto;">
  {% for tag in usertags %}
  <input type="checkbox" name="update_tag_{{ tag|base32 }}" value="true" /><span class="tag">{{ tag }}</span><br />
  {% endfor %}
  </div>
  <br />
  Assign new tags:<br />
  <input type="text" name="new_tags" /><br />
  <br />
  <input type="submit" id="update_tags" name="update_tags" value="Update" style="float: right;" />
</div>
</li>


{% if manage %}
{% if perms.presentation.publish_presentations %}
<li><input type="submit" name="hide" value="Hide" /></li>
<li><input type="submit" name="unhide" value="Show" /></li>
{% endif %}
<li><input type="submit" id="delete" name="delete" value="Delete" /></li>
{% endif %}


<li class="pagination">{% paginate %}</li>

</ul>

<br style="clear: left;" />


{% endblock %}



{% block content %}

{% if presentations %}

<table summary="List of Presentations" class="itemactions">
    <tr>
        <th></th>
        <th>Title</th>
        {% if manage %}
        {% if perms.presentation.publish_presentations %}
        <th>Hidden</th>
        {% endif %}
        <th>Created</th>
        <th>Modified</th>
        {% else %}
        <th>Presenter</th>
        {% endif %}
        <th>Tags</th>
        <th>Items</th>
        <th></th>
        <th></th>
    </tr>
{% for presentation in presentations %}
    {% owned_tags_for_object presentation for request.user as ptags %}
    {% owned_tags_for_object presentation for presentation.owner as otags %}
    <tr>
        <td><input type="checkbox" name="h" value="{{ presentation.id }}" /></td>
        <td>
            {% if manage %}
            <a href="{% url presentation-edit presentation.id, presentation.name %}">{{ presentation.title }}</a>
            {% else %}
            {{ presentation.title }}
            {% endif %}
        </td>
        {% if manage %}
        {% if perms.presentation.publish_presentations %}
        <td>{{ presentation.hidden|yesno:"hidden,-" }}</td>
        {% endif %}
        <td>{{ presentation.created|naturalday:"M j, Y" }}</td>
        <td>{{ presentation.modified|naturalday:"M j, Y" }}</td>
        {% else %}
        <td>{% if presentation.owner.last_name %}{{ presentation.owner.last_name }}, {{ presentation.owner.first_name }}{% else %}{{ presentation.owner.username }}{% endif %}</td>
        {% endif %}
        <td>{% for ptag in ptags %}
                {% tag ptag presentation "True" %}
            {% endfor %}
            {% if not manage %}
            {% for otag in otags %}
                {% tag otag presentation 0 'secondary' %}
            {% endfor %}
            {% endif %}
        </td>
        <td>{% with presentation.hidden_item_count as h %}
          {{ presentation.visible_item_count }}{% if h %}&nbsp;(+{{h}}){% endif %}
          {% endwith %}
        </td>
        <td>{% if presentation.password %}
                {% if presentation.unlocked %}
                <img src="{% url static "images/unlocked.png" %}" />
                {% else %}
                <img src="{% url static "images/locked.png" %}" />
                {% endif %}
            {% endif %}
        </td>
        <td class="item-actions">
            {% if not presentation.password or presentation.unlocked %}
            {% list_viewers presentation request.get_full_path %}
            {% else %}
            <a href="{% url presentation-password presentation.id, presentation.name %}?next={{ request.get_full_path|urlencode }}">Unlock</a>
            {% endif %}
        </td>
    </tr>
{% endfor %}
</table>


{% else %}
No presentations available.
{% endif %}


{% endblock %}
