{% extends "master.html" %}
{% load help %}
{% load comments %}
{% load humanize %}

{% block stylesheets %}
{{ block.super }}
    <style type="text/css">

#image-preview {
    width: 800px;
    margin: 40px auto 40px auto;
}

.columns {
    width: 840px;
    margin: 0 auto;
    overflow: hidden;
}

.columns-bottom {
    font-size: 0;
    height: 1px;
}

.column {
    width: 368px;
    float: left;
    margin-left: 20px;
    padding: 10px;
    margin-bottom: -9000px;
    padding-bottom: 9010px;
    border: 1px solid #bfbfbf;
    background-color: #f1f1f1;
}

#image-preview a {
    text-decoration: none;
}

.image-preview-main {
    width: 560px;
    height: 420px;
    text-align: center;
    position: absolute;
}

#image-preview-container {
    position: relative;
    width: 560px;
    height: 420px;
    float: left;
    margin: 1px 20px 1px 0;
    background-color: #f1f1f1;
    border: 1px solid #bfbfbf;
}

#image-preview .image-title {
    width: 560px;
}

#image-preview-reload {
    clear: both;
    float: right;
    font-size: x-small;
    padding-right: 8px;
}

#image-preview .image-title a {
    font-weight: bolder;
    font-size: larger;
    color: black;
}

#image-preview .image-subtitle a {
    font-size: smaller;
    color: #76939a;
}

.image-preview-thumb {
    width: 100px;
    height: 100px;
    float: left;
    border: solid white 3px;
    opacity: 0.5;
    filter: alpha(opacity=50);
}

.active-image-preview-thumb {
    border: solid rgb(152, 189, 198) 3px;
    opacity: 1.0;
    filter: alpha(opacity=100);
}

.image-preview-thumb img {
    width: 100px;
    height: 100px;
}

.announcements p {
    margin: 0;
}

.announcements .byline {
    font-size: x-small;
    font-style: italic;
}

#loginform label {
    position: absolute;
}

#loginform input {
    margin-left: 7em;
}

    </style>
{% endblock %}

{% block javascript %}
{{ block.super }}
    <script type="text/javascript">
        var order = {{ order }};
        var data = [
{% for record in records %}
['{{ record.title|escapejs }}',
 '{{ record.get_absolute_url }}',
 {% with record.collection_set.all.0 as collection %}
 '{{ collection.title|escapejs }}',
 '{% url solr-search-collection collection.id, collection.name %}',
 {% endwith %}
 ]{% if not forloop.last %},{% endif %}
{% endfor %}
        ];
        var index = 0;
        var position = 0;
        var interval;
        var hovertimeout;
        
        function nextImage(newposition) {
            if (position == newposition) return;
            var title = $("#image-preview .image-title a");
            var subtitle = $("#image-preview .image-subtitle a");
            var current = position;
            position = newposition;
            var d = data[position];
            $("#image-preview .image-preview-main").eq(current).fadeOut(1000);
            $("#image-preview .image-preview-main").eq(position).fadeIn(1000);
            title.fadeOut(500, function() { title.html(d[0]).attr("href", d[1]).fadeIn(500); });
            subtitle.fadeOut(500, function() { subtitle.html(d[2]).attr("href", d[3]).fadeIn(500); });
            $("#image-preview .image-preview-thumb").removeClass("active-image-preview-thumb").eq(position).addClass("active-image-preview-thumb");
        }
        
        function autoAdvance() {
            interval = setInterval(function() { index = (index + 1) % 8; nextImage(order[index]); }, 10000);
        }
        
        $(window).load(function () {
            autoAdvance();
        });
        
        $(document).ready(function() {
            $("#image-preview .image-preview-thumb").hover(
                function() {
                    clearInterval(interval);
                    clearTimeout(hovertimeout);
                    var n = $(this).prevAll().length - 1;
                    hovertimeout = setTimeout(function() { nextImage(n); }, 500)
                },
                function() {
                    clearTimeout(hovertimeout);
                    autoAdvance();
                }
            );
            $("#image-preview .image-preview-main").hover(
                function() {
                    clearInterval(interval);
                },
                autoAdvance
            );
        });
    </script>
{% endblock %}

{% block content %}

  {% include "ie6warning.html" %}

  {% if records %}
  <div id="image-preview">
    <div id="image-preview-container">
        {% for record in records %}
        {% with record.title as title %}
        <div class="image-preview-main"{% if not forloop.first %} style="display: none;"{% endif %}>
            <a href="{{ record.get_absolute_url }}">
                <img src="{% url storage-retrieve-image record.id, record.name, 560, 420 %}" title="{{ title }}" alt="{{ title }}" />
            </a>
        </div>
        {% endwith %}
        {% endfor %}
    </div>
    {% for record in records %}
        {% with record.title as title %}
    <div class="image-preview-thumb{% if forloop.first %} active-image-preview-thumb{% endif %}">
        <a href="{{ record.get_absolute_url }}">
            <img src="{{ record.get_thumbnail_url }}?square" title="{{ title }}" alt="{{ title }}" />
        </a>
    </div>
        {% endwith %}
    {% endfor %}
    <div id="image-preview-reload"><a href=".">Load new images</a></div>
    {% with records.0.collection_set.all.0 as collection %}
    <div class="image-title"><a href="{{ records.0.get_absolute_url }}">{{ records.0.title }}</a></div>
    <div class="image-subtitle"><a href="{% url solr-search-collection collection.id, collection.name %}">{{ collection.title }}</a></div>
    {% endwith %}
  </div>
  {% endif %}

  <div class="columns">
  
    <div class="column">
    {% if not user.is_authenticated %}
        <h2>Log in</h2>
        <form method="POST" action="{% url login %}" id="loginform">
            {{ form.as_p }}
            <input type="submit" value="Log in" />
        </form>
    {% else %}
        <h2>Welcome{% if user.first_name %}, {{ user.first_name }}{% endif %}</h2>
    {% endif %}
    </div>
    
    <div class="column announcements">
        
        <h2>Announcements</h2>
        
        {% get_comment_list for flatpages.flatpage 1 as comments %}
        {% for comment in comments %}
            {{ comment.comment|linebreaks }}
            <div class="byline">Posted {{ comment.submit_date|naturalday }} by {{ comment.user }}.</div>
        {% endfor %}
        
    </div>
        
  </div>
  
    <div class="columns columns-bottom">
        <div class="column"></div>
        <div class="column"></div>
    </div>
    

{% endblock %}